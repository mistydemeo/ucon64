DLOPEN=1
#ZLIB=1

CC=cl.exe
CFLAGS=/nologo /W3 /O2 /DHAVE_CONFIG_H /DDLL
!ifdef DLOPEN
CFLAGS=$(CFLAGS) /DDLOPEN
!endif

LIBNAME=discmage
OBJECTS=libdm_misc.obj dllinit.obj misc.obj format/format.obj format/cdi.obj \
        format/nero.obj format/cue.obj format/toc.obj format/other.obj
!ifdef ZLIB
LIBS=zlib.lib
OBJECTS=$(OBJECTS) unzip.obj map.obj miscz.obj
!else
LIBS=
!endif


FULLLIBNAME=$(LIBNAME).dll
DLLFLAGS=/NOLOGO /DLL $(OBJECTS) $(LIBS) /DEF:$(LIBNAME).def /OUT:$(LIBNAME).dll


all: $(FULLLIBNAME)


clean:
	del $(LIBNAME).dll
	del $(LIBNAME).lib
	del *.obj
	del format\*.obj
	del $(LIBNAME).exp


distclean: clean
	del config.h


.c.obj:
	$(CC) $(CFLAGS) /c $< /Fo$@


$(LIBNAME).dll: $(OBJECTS)
	link.exe $(DLLFLAGS)
# link.exe automatically creates the import library. "/IMPLIB:filename.lib"
#  could be used to give the import library another name
#	lib.exe $(DLLFLAGS) /OUT:$(LIBNAME).lib

install:

uninstall:


# Dependencies
LIBDM_STD_H=libdiscmage.h misc.h dxedll_priv.h format/format.h

libdm_misc.obj: $(LIBDM_STD_H)
format/format.obj: $(LIBDM_STD_H)
format/cdi.obj: format/cdi.h $(LIBDM_STD_H)
format/nero.obj: format/nero.h $(LIBDM_STD_H)
format/cue.obj: format/cue.h $(LIBDM_STD_H)
format/toc.obj: format/toc.h $(LIBDM_STD_H)
format/other.obj: format/other.h $(LIBDM_STD_H)
dllinit.obj: $(LIBDM_STD_H)
misc.obj: misc.h dxedll_priv.h
miscz.obj: miscz.h misc.h dxedll_priv.h
dxe_misc.obj: dxedll_pub.h
djimport.obj: libdiscmage.h dlopen.h dxedll_pub.h
dlopen.obj: dlopen.h dxedll_pub.h
