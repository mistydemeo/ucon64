.PHONY: all clean distclean install uninstall

CC=@CC@
SRCDIR=@srcdir@

CFLAGS=-I. -Wall -O3
LDFLAGS=-s
#LDFLAGS+=-lz

OBJECTS=ucon64.o ucon64_misc.o ucon64_db.o misc.o getopt.o \
        patch/aps.o patch/bsl.o patch/ips.o patch/gg.o patch/pal4u.o \
        patch/ppf.o patch/xps.o \
        gb/gb.o gba/gba.o genesis/genesis.o lynx/lynx.o n64/n64.o \
        neogeo/neogeo.o nes/nes.o ngp/ngp.o pce/pce.o sms/sms.o psx/psx.o \
        snes/snes.o swan/swan.o dc/dc.o jaguar/jaguar.o sample/sample.o \
        backup/yoko.o backup/ssc.o backup/interceptor.o backup/cdrw.o \
        backup/z64.o backup/cd64.o backup/doctor64.o backup/doctor64jr.o \
        backup/fal.o backup/fig.o backup/fpl.o backup/gbx.o backup/mgd.o \
        backup/smc.o backup/smd.o backup/swc.o backup/dex.o backup/psxpblib.o \
        backup/mccl.o backup/lynxit.o


TARGET=ucon64
ifeq ($(TERM),cygwin)                   # OSTYPE is not a real env var on Cygwin
TARGET:=$(addsuffix .exe, $(TARGET))    # GNU specific: "simply expanded variable"
else                                    # adding .exe avoids "problems" with Cygwin
ifdef DJGPP                             # OSTYPE is not defined by default under DOS
TARGET:=$(addsuffix .exe, $(TARGET))
endif                                   # DJGPP
endif                                   # cygwin

all: $(TARGET)

# The test for Cygwin should be done before the test for DJGPP, because the
# environment variable DJGPP can be set under Bash for people who have
# installed both gcc (and friends) ports.

clean:
ifeq ($(TERM),cygwin)                   # test cygwin before DJGPP
	rm -f $(TARGET) $(OBJECTS) *.core *.stackdump *~ */*~ */*/*~ \
              DEADJOE */DEADJOE *~ */*~ */*/*~
else
ifdef DJGPP
	del *.o
	del patch\*.o
	del gb\*.o
	del genesis\*.o
	del jaguar\*.o
	del lynx\*.o
	del n64\*.o
	del neogeo\*.o
	del nes\*.o
	del ngp\*.o
	del pce\*.o
	del sms\*.o
	del snes\*.o
	del gba\*.o
	del dc\*.o
	del swan\*.o
	del sample\*.o
	del backup\*.o
	del $(TARGET)
else                                    # Unix or BeOS
	rm -f $(TARGET) $(OBJECTS) *.core *.stackdump *~ */*~ */*/*~ \
              DEADJOE */DEADJOE *~ */*~ */*/*~

endif                                   # DJGPP
endif                                   # cygwin

distclean: clean
ifeq ($(TERM),cygwin)                   # test cygwin before DJGPP
	rm -f ../bin/$(TARGET)
else
ifdef DJGPP
	del ..\bin\$(TARGET)
else
	rm -f ../bin/$(TARGET)
endif                                   # DJGPP
endif                                   # cygwin


.c.o:
	$(CC) $(CFLAGS) -c $< -o $@


$(TARGET): $(OBJECTS)
	$(CC) -o $@ $(OBJECTS) $(LDFLAGS)
ifeq ($(TERM),cygwin)                   # test cygwin before DJGPP
	cp $(TARGET) ../bin
else
ifdef DJGPP
	copy $(TARGET) ..\bin
else
	cp $(TARGET) ../bin
endif                                   # DJGPP
endif                                   # cygwin

install:
ifeq ($(TERM),cygwin)                   # test cygwin before DJGPP
	cp $(TARGET) ../bin
else
ifdef DJGPP
	copy $(TARGET) ..\bin
else
ifeq ($(OSTYPE),beos)
	./install_beos.sh
else
	./install.sh
endif                                   # beos
endif                                   # DJGPP
endif                                   # cygwin


uninstall:
ifeq ($(TERM),cygwin)                   # test cygwin before DJGPP
	rm -f ../bin/$(TARGET)
else
ifdef DJGPP
	del ..\bin\$(TARGET)
else
ifeq ($(OSTYPE),beos)
	rm -f $(HOME)/config/bin/$(TARGET)
else
	rm -f /usr/local/bin/$(TARGET)
endif                                   # beos
endif                                   # DJGPP
endif                                   # cygwin


# Dependencies

# Most source files include these
UCON64_STD_H=ucon64.h ucon64_misc.h misc.h config.h ucon64_defines.h

getopt.o: getopt.h
misc.o: misc.h
ucon64.o: switches.c options.c $(UCON64_STD_H)
ucon64_misc.o: $(UCON64_STD_H)
ucon64_db.o: ucon64_db.h $(UCON64_STD_H)
gb/gb.o: gb/gb.h $(UCON64_STD_H)
gba/gba.o: gba/gba.h $(UCON64_STD_H)
genesis/genesis.o: genesis/genesis.h $(UCON64_STD_H)
jaguar/jaguar.o: jaguar/jaguar.h $(UCON64_STD_H)
lynx/lynx.o: lynx/lynx.h $(UCON64_STD_H)
n64/n64.o: n64/n64.h $(UCON64_STD_H)
neogeo/neogeo.o: neogeo/neogeo.h $(UCON64_STD_H)
nes/nes.o: nes/nes.h $(UCON64_STD_H)
ngp/ngp.o: ngp/ngp.h $(UCON64_STD_H)
pce/pce.o: pce/pce.h $(UCON64_STD_H)
sms/sms.o: sms/sms.h $(UCON64_STD_H)
snes/snes.o: snes/snes.h $(UCON64_STD_H)
swan/swan.o: swan/swan.h $(UCON64_STD_H)
dc/dc.o: dc/dc.h $(UCON64_STD_H)
psx/psx.o: psx/psx.h $(UCON64_STD_H)
patch/aps.o: patch/aps.h $(UCON64_STD_H)
patch/bsl.o: patch/bsl.h $(UCON64_STD_H)
patch/ips.o: patch/ips.h $(UCON64_STD_H)
patch/ppf.o: patch/ppf.h $(UCON64_STD_H)
patch/xps.o: patch/xps.h $(UCON64_STD_H)
patch/pal4u.o: patch/pal4u.h $(UCON64_STD_H)
patch/gg.o: patch/gg.h $(UCON64_STD_H)
backup/doctor64.o: backup/doctor64.h $(UCON64_STD_H)
backup/doctor64jr.o: backup/doctor64jr.h $(UCON64_STD_H)
backup/fal.o: backup/fal.h backup/cartlib.c $(UCON64_STD_H)
backup/fig.o: backup/fig.h $(UCON64_STD_H)
backup/fpl.o: backup/fpl.h $(UCON64_STD_H)
backup/gbx.o: backup/gbx.h $(UCON64_STD_H)
backup/mgd.o: backup/mgd.h $(UCON64_STD_H)
backup/smc.o: backup/smc.h $(UCON64_STD_H)
backup/smd.o: backup/smd.h $(UCON64_STD_H)
backup/swc.o: backup/swc.h $(UCON64_STD_H)
backup/cd64.o: backup/cd64.h $(UCON64_STD_H)
backup/cdrw.o: backup/cdrw.h $(UCON64_STD_H)
backup/dex.o: backup/dex.h backup/psxpblib.h $(UCON64_STD_H)
backup/mccl.o: backup/mccl.h $(UCON64_STD_H)
backup/lynxit.o: backup/lynxit.h $(UCON64_STD_H)


# with this"make" will automatically reconfigure if the .in' files change.

# automatic re-running of configure if the ocnfigure.in file has changed
${SRCDIR}/configure: configure.in aclocal.m4
	cd ${SRCDIR} && autoconf

# autoheader might not change config.h.in, so touch a stamp file
${SRCDIR}/config.h.in: stamp-h.in
${SRCDIR}/stamp-h.in: configure.in aclocal.m4
	cd ${SRCDIR} && autoheader
	echo timestamp > ${SRCDIR}/stamp-h.in

config.h: stamp-h
stamp-h: config.h.in config.status
	./config.status
Makefile: Makefile.in config.status
	./config.status
config.status: configure
	./config.status --recheck
